---
title: "Microbial Competition and Tree Functional Plasticity"
subtitle: "Replicating and Extending Jiang et al. (Nature, 2024)"
author: "Gia Trieu Pham; Ani Ugrelidze; Oishanu Dutta; Muhammad Hasher Naveed"
date: last-modified
format: 
  html:
    theme: cosmo
    toc: true
    number-sections: true
    code-fold: true
    embed-resources: true
    df_print: paged
execute:
  warning: false
  message: false
---

```{r setup}
#| include: false

# --- PART 1: SETUP ---
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, lubridate, lme4, lmerTest, knitr, kableExtra, here, broom.mixed, patchwork)

# Visualization Theme
theme_set(theme_classic(base_size = 12))
cols <- c("Ambient" = "#377EB8", "eCO2" = "#E41A1C")

# Helper: Map Rings to Treatments
get_trt <- function(ring) { ifelse(ring %in% c(1,4,5), "eCO2", "Ambient") }

# --- UPDATED & FIXED STATS FUNCTION ---
print_stats <- function(model, caption) {
  # 1. Get ANOVA table safely
  stats_df <- suppressWarnings(anova(model)) %>% as.data.frame()
  
  # 2. Standardize Column Names
  if("F value" %in% names(stats_df)) stats_df <- rename(stats_df, `F-Statistic` = `F value`)
  if("Pr(>F)" %in% names(stats_df))  stats_df <- rename(stats_df, `P-Value` = `Pr(>F)`)
  
  stats_df %>%
    # 3. Round numeric columns
    mutate(across(any_of(c("Sum Sq", "Mean Sq", "F-Statistic")), \(x) round(x, 2)),
           across(any_of(c("NumDF", "Df")), \(x) round(x, 0)),
           across(any_of("DenDF"), \(x) round(x, 1))) %>%
    # 4. robust P-value formatting (Text-based to prevent HTML errors)
    mutate(
      `Sig` = ifelse(!is.na(`P-Value`) & `P-Value` < 0.05, "*", ""), # Add Star for significance
      `P-Value` = ifelse(`P-Value` < 0.001, "< 0.001", sprintf("%.3f", `P-Value`))
    ) %>%
    # 5. Create Table
    kable(caption = caption, align = "r") %>% 
    kable_styling(full_width = F, bootstrap_options = "striped") %>%
    footnote(
      general = "* Indicates statistical significance (P < 0.05).",
      general_title = "Note: "
    )
}

```

# Introduction

## Scientific Context

Elevated atmospheric CO2 (eCO2) typically stimulates plant growth. . However, in the mature Eucalyptus forest of the EucFACE experiment, biomass growth has remained stagnant. Jiang et al. (2024) propose the "Microbial Pre-emption Hypothesis": soil microbes aggressively compete for scarce phosphorus (P), creating a nutrient bottleneck that prevents trees from utilizing the extra carbon.

We replicate and extend **Jiang et al. (2024)**, investigating "Microbial Pre-emption" at the EucFACE experiment. We test if microbes lock away Phosphorus (P), causing biomass stagnation, and if trees respond via functional plasticity.

## Objectives

1.  **The Lockout:** Microbial P pools \> Available Soil P pools.

2.  **Stagnation:** No increase in wood biomass under eCO2.

3.  **Adaptation:** Trees shift allocation to roots (Foraging) or increase P-use efficiency (PUE).

# Materials & Methods

We aggregated data from 2013–2016. We used Linear Mixed Models (LMM) with Ring as a random effect.

```{r}
#| label: data-processing

# --- 1. ROBUST DATA LOADER ---
load_data <- function(filename, val_col_pattern, type = "pool") {
  path <- here("EucFACE_P_Analysis/data", filename)
  if(!file.exists(path)) path <- here("data", filename) 
  if(!file.exists(path)) return(NULL)
  
  df <- read_csv(path, show_col_types = FALSE)
  val_col <- names(df)[grepl(val_col_pattern, names(df), ignore.case = TRUE)][1]
  
  clean_df <- df %>%
    mutate(Date = parse_date_time(Date, orders = c("ymd", "dmy", "mdy")),
           Year = year(Date)) %>%
    filter(!is.na(Date)) %>% 
    rename(Value = all_of(val_col))
    
  if (type == "pool") {
    out <- clean_df %>% group_by(Year, Ring) %>% summarise(Val = mean(Value, na.rm=TRUE), .groups="drop")
  } else if (type == "sum_depth") {
    out <- clean_df %>% 
      filter(Depth %in% c("0_10", "10_30")) %>%
      group_by(Date, Ring) %>% summarise(DailySum = sum(Value), .groups="drop") %>%
      mutate(Year = year(Date)) %>%
      group_by(Year, Ring) %>% summarise(Val = mean(DailySum, na.rm=TRUE), .groups="drop")
  } else if (type == "flux") {
    out <- clean_df %>% group_by(Year, Ring) %>% summarise(Val = mean(Value, na.rm=TRUE)*365/1000, .groups="drop")
  }
  return(out)
}

# --- 2. EXECUTE LOADING ---
soil_p  <- load_data("soil_phosphate_pool.csv", "phosphate", type="sum_depth") %>% rename(Soil_P = Val)
micro_p <- load_data("microbial_p_pool.csv", "microbial", type="sum_depth") %>% rename(Micro_P = Val)
wood_c  <- load_data("wood_c_pool.csv", "wood", type="pool") %>% rename(Wood_C = Val)
root_c  <- load_data("fineroot_c_pool.csv", "fineroot", type="pool") %>% rename(Root_C = Val)
gpp     <- load_data("overstorey_gpp_flux.csv", "GPP", type="pool") %>% rename(GPP = Val)

litter_files <- c("leaflitter_p_flux.csv", "twiglitter_p_flux.csv", "bark_litter_p_flux.csv", "seed_litter_p_flux.csv")
litter_list  <- lapply(litter_files, function(f) load_data(f, "flux|mg", type="flux"))
litter_p <- bind_rows(litter_list) %>% 
  group_by(Year, Ring) %>% 
  summarise(Total_P_Lost = sum(Val, na.rm=TRUE), .groups="drop")

# --- 3. MASTER MERGE ---
df_list <- list(wood_c, root_c, gpp, litter_p, soil_p, micro_p)
df <- df_list %>% 
  reduce(full_join, by = c("Year", "Ring")) %>% 
  mutate(Trt = get_trt(Ring), Ring = factor(Ring)) %>% 
  filter(Year >= 2013 & Year <= 2016) %>% 
  mutate(PUE = GPP / Total_P_Lost, Root_Shoot_Ratio = Root_C / Wood_C)
```

# Results: Replication Phase

## The Phosphorus Inventory

We compared the three main Phosphorus compartments: Available Soil P, Microbial P and Tree P Return (Litter Flux).

```{r}
#| label: fig-pools
#| fig-cap: "The Ecosystem Phosphorus Budget. (A) Time series of P pools. Note that the Microbial pool (Middle) is ~10x larger than the Soil pool (Left) or Tree Return (Right). (B) The negative relationship between Microbes and Soil P suggests active drawdown."

# --- 1. PREPARE DATA ---
# We add "Total_P_Lost" (Litter) as a proxy for Tree P cycling
df_long_p <- df %>% 
  select(Year, Ring, Trt, Soil_P, Micro_P, Total_P_Lost) %>% 
  pivot_longer(cols = c(Soil_P, Micro_P, Total_P_Lost), names_to = "Type", values_to = "Val") %>% 
  mutate(Type = recode(Type, 
                       "Soil_P" = "1. Available Soil P", 
                       "Micro_P" = "2. Microbial P (Lockout)",
                       "Total_P_Lost" = "3. Tree P Return (Litter)")) %>% 
  drop_na(Val)

# --- 2. PLOT A: TIME SERIES ---
plot_a <- ggplot(df_long_p, aes(x = Year, y = Val, color = Trt)) +
  geom_line(aes(group = Ring), alpha = 0.3, linewidth = 0.6) + 
  stat_summary(fun = mean, geom = "line", linewidth = 1.2) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.1) +
  facet_wrap(~Type, scales = "free_y", nrow = 1) + 
  scale_color_manual(name = "Treatment", values = cols) +
  scale_x_continuous(breaks = c(2013, 2014, 2015, 2016)) +
  labs(y = "Phosphorus (g P / m²)", x = NULL, title = "A. Magnitude of P Pools") +
  theme(legend.position = "top",
        strip.background = element_rect(fill = "#f0f0f0", color = NA),
        strip.text = element_text(face = "bold", size = 10))

# --- 3. PLOT B: CORRELATION (RELATION) ---
# Is there a trade-off? As Microbes go UP, does Soil P go DOWN?
plot_b <- ggplot(df, aes(x = Micro_P, y = Soil_P, color = Trt)) +
  geom_point(alpha = 0.6, size = 2) +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.2) +
  scale_color_manual(name = "Treatment", values = cols) +
  labs(y = "Available Soil P", x = "Microbial P", title = "B. Microbial Drawdown") +
  theme(legend.position = "none")

# Combine plots using patchwork
plot_a / plot_b + plot_layout(heights = c(2, 1))
```

```{r}
#| label: tbl-pools
#| tbl-cap: "ANOVA: Comparison of Ecosystem P Compartments."

m_pool <- lmer(Val ~ Type * Trt + (1|Ring), data = df_long_p)
print_stats(m_pool, "Model: Value ~ Compartment * Treatment")
```

**Observation:** As shown in *\@fig-pools*, the Microbial P pool is orders of magnitude larger than the Soil P pool (See \@tbl-pools, P \< 0.001).

**Analysis:** The "lockout" shown in Figure 1 has a direct consequence. As seen in \@fig-wood, the wood biomass trajectories for Ambient and eCO2 treatments overlap completely P=0.957

\@tbl-wood). The nutrient bottleneck prevents the conversion of extra Carbon into Wood.

**Analysis of The Lockout:**

1.  **Magnitude:** As shown in *\@fig-pools* (Panel A), the Microbial P pool (Middle) is orders of magnitude larger than the Available Soil P (Left) or the Tree P Return (Right). \@tbl-pools confirms that the differences between these compartments are highly significant (P\<0.001).

2.  **Drawdown:** Panel B illustrates the mechanism. There is a negative correlation between Microbial biomass and Soil P. This suggests that microbes are actively drawing down the soil solution, preventing P from accumulating for tree use.

## The Consequence: Biomass Stagnation

```{r}
#| label: fig-wood
#| fig-cap: "Wood Biomass Trajectory. Despite elevated CO2, the red line (eCO2) does not diverge from the blue line (Ambient)."

ggplot(df, aes(x=Year, y=Wood_C, color=Trt)) +
  geom_line(aes(group = Ring), alpha = 0.3, linewidth = 0.6) +
  stat_summary(fun=mean, geom="line", linewidth=1.2) +
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.1) +
  scale_color_manual(name="Treatment", values=cols) +
  scale_x_continuous(breaks=2013:2016) +
  labs(y="Wood Carbon (g C / m²)")
```

```{r}
#| label: tbl-wood
#| tbl-cap: "ANOVA: Treatment Effect on Wood Biomass."

m_wood <- lmer(Wood_C ~ Trt * as.factor(Year) + (1|Ring), data=df)
print_stats(m_wood, "ANOVA: Treatment Effect on Wood Biomass")
```

**Observation:** The nutrient lockout has successfully prevented a growth response. As seen in \@fig-wood, the wood biomass trajectories for Ambient and eCO2 treatments overlap completely. The ANOVA in \@tbl-wood confirms that the Treatment effect is non-significant (P=0.957).

# Results: Extension Phase (Adaptation)

## Root Investment Strategies

```{r}
#| label: fig-root
#| fig-cap: "Root:Wood Allocation Ratio. The high variability in the faint lines (individual rings) suggests that allocation strategies are driven more by local conditions than by the global CO2 treatment."

ggplot(df %>% filter(!is.na(Root_Shoot_Ratio)), aes(x = Year, y = Root_Shoot_Ratio, color = Trt)) +
  geom_line(aes(group = Ring), alpha = 0.4, linewidth = 0.8) + 
  geom_point(aes(group = Ring), alpha = 0.4) +
  stat_summary(aes(group = Trt), fun = mean, geom = "line", 
               linewidth = 1.5, linetype = "dashed") +
  scale_color_manual(name="Treatment", values = cols) +
  scale_x_continuous(breaks = 2013:2016) +
  labs(y = "Root : Wood Ratio", x = "Year")
```

```{r}
#| label: tbl-root
#| tbl-cap: "ANOVA: Effect of Individual Rings on Allocation."

lm_ring <- lm(Root_Shoot_Ratio ~ Ring + as.factor(Year), data = df)
print_stats(lm_ring, "ANOVA: Effect of Individual Rings on Allocation")
```

**Analysis:** While the global treatment effect is weak, *\@tbl-root* shows that individual **Rings** drive significant variation (P\<0.05). This indicates **Spatial Contingency**: trees allocate roots based on their specific local soil patch conditions rather than a uniform response to CO2.

## Functional Efficiency (PUE)

```{r}
#| label: fig-pue
#| fig-cap: "Functional Plasticity (PUE). eCO2 trees trend towards higher productivity per unit Soil P."

df_flux <- df %>% filter(!is.na(PUE) & !is.na(Soil_P))

ggplot(df_flux, aes(x=Soil_P, y=GPP, color=Trt, fill=Trt)) +
  geom_point(size=3, alpha=0.6, shape=21, color="white") +
  geom_smooth(method="lm", alpha=0.2) +
  scale_color_manual(name="Treatment", values=cols) +
  scale_fill_manual(name="Treatment", values=cols) +
  labs(x="Available Soil Phosphorus (g/m²)", y="Carbon Uptake (GPP)")
```

```{r}
#| label: tbl-pue
#| tbl-cap: "ANOVA: PUE Interaction (Soil P x Treatment)."

m_pue <- lmer(GPP ~ Soil_P * Trt + (1|Ring), data=df_flux)
print_stats(m_pue, "ANOVA: PUE Interaction")
```

**Analysis:** As seen in *\@fig-pue*, eCO2 trees (Red) visually maintain higher GPP than ambient trees for the same level of Soil P, suggesting a shift in efficiency. However, *\@tbl-pue* indicates this interaction is not statistically significant (P\>0.05), likely due to the high noise-to-signal ratio in the ecosystem.

# Conclusion

1.  **Mechanism Confirmed:** We replicated the findings of Jiang et al. (2024), confirming that **Microbial Pre-emption** (*\@fig-pools*) successfully blocks the expected fertilization effect of eCO2, leading to **Biomass Stagnation** (*\@fig-wood*).

2.  **Adaptation Limits:** Trees are not entirely passive. They show significant shifts in root allocation over time and space (*\@tbl-root*), but these responses are driven by **local heterogeneity (Ring effects)** rather than a uniform response to CO2 (*\@fig-pue*).

# Reference

*Jiang M, Crous KY, Carrillo Y, et al. Microbial competition for phosphorus limits the CO2 response of a mature forest. Nature. 2024;630(8017):660-665. doi:10.1038/s41586-024-07491-0*
