) %>% left_join(trt_map, by="Ring")
# B. P BUDGET (The Heist)
# Uptake = (Demands) - (Recycling)
df_uptake_calc <- p_wood_dem %>% rename(WD=Value) %>%
left_join(p_leaf_dem, by=c("Year","Ring")) %>% rename(LD=Value) %>%
left_join(p_root_dem, by=c("Year","Ring")) %>% rename(RD=Value) %>%
left_join(p_wood_ret, by=c("Year","Ring")) %>% rename(WR=Value) %>%
left_join(p_leaf_ret, by=c("Year","Ring")) %>% rename(LR=Value) %>%
left_join(p_root_ret, by=c("Year","Ring")) %>% rename(RR=Value) %>%
mutate(Uptake = (WD+LD+RD) - (WR+LR+RR)) %>%
select(Year, Ring, Uptake)
df_budget <- bind_rows(
p_supply %>% mutate(Type = "Soil Supply"),
df_uptake_calc %>% rename(Value=Uptake) %>% mutate(Type = "Tree Uptake")
) %>% left_join(trt_map, by="Ring")
# C. POOLS (The Inventory)
df_pools <- bind_rows(
pool_mic %>% mutate(Type = "Microbial P"),
pool_plant %>% mutate(Type = "Total Plant P")
) %>% left_join(trt_map, by="Ring")
# D. EFFICIENCY (Stoichiometry)
df_pue <- c_gpp %>% rename(GPP=Value) %>%
left_join(p_leaf_dem, by=c("Year","Ring")) %>% rename(LeafP=Value) %>%
mutate(PUE = GPP / LeafP) %>%
left_join(trt_map, by="Ring")
# 5. PLOTTING THE STORY ---------------------------------------------------
# 1. Biomass Stagnation
p1 <- ggplot(df_carbon, aes(x=Trt, y=Value, fill=Trt)) +
geom_boxplot(alpha=0.6) + geom_jitter(width=0.1, alpha=0.5) +
facet_wrap(~Type, scales="free") +
labs(title="1. Biomass Stagnation", y="Carbon Flux (g C m-2 yr-1)", x="") +
theme_bw() + theme(legend.position="none") +
scale_fill_manual(values=c("aCO2"="#F8766D", "eCO2"="#00BFC4"))
# 2. The Heist (Supply vs Uptake)
p2 <- ggplot(df_budget, aes(x=Trt, y=Value, fill=Type)) +
geom_boxplot(alpha=0.6) +
labs(title="2. The Phosphorus Gap", y="P Flux (g P m-2 yr-1)", x="") +
theme_bw() + scale_fill_manual(values=c("orange", "forestgreen")) +
theme(legend.position="bottom")
# 3. The Inventory (Pools)
p3 <- ggplot(df_pools, aes(x=Type, y=Value, fill=Trt)) +
geom_boxplot(alpha=0.6) +
labs(title="3. Phosphorus Inventory", y="P Pool (g P m-2)", x="") +
theme_bw() + scale_fill_manual(values=c("aCO2"="#F8766D", "eCO2"="#00BFC4"))
# 4. Efficiency
p4 <- ggplot(df_pue, aes(x=Trt, y=PUE, fill=Trt)) +
geom_boxplot(alpha=0.6) +
labs(title="4. Efficiency (PUE)", y="g C per g P", x="") +
theme_bw() + theme(legend.position="none") +
scale_fill_manual(values=c("aCO2"="#F8766D", "eCO2"="#00BFC4"))
# 6. SAVE OUTPUT ----------------------------------------------------------
final_plot <- (p1 + p2) / (p3 + p4)
ggsave("MASTER_ANALYSIS_OUTPUT.png", final_plot, width=12, height=10)
print(">>> SUCCESS! Open 'MASTER_ANALYSIS_OUTPUT.png' to see the complete story.")
# ==============================================================================
# MASTER SCRIPT: EucFACE PHOSPHORUS LIMITATION PROJECT
# Combined Analysis: Carbon Stagnation, P Flux Heist, and P Pool Hoarding
# ==============================================================================
# 1. CONTROL CENTER (SETUP) -----------------------------------------------
library(tidyverse)
library(lubridate)
library(lme4)
library(lmerTest)
library(patchwork)
library(ggplot2)
# --- DEFINING PATHS ---
# UPDATE THESE TO MATCH YOUR COMPUTER EXACTLY
path_flux <- "C:/Users/augre/Desktop/UPV S1/Data/2025Bgroup-phosphorusCO2/Flux_data"
path_pool <- "C:/Users/augre/Desktop/UPV S1/Data/2025Bgroup-phosphorusCO2/Pool data"
# --- DEFINING TREATMENTS ---
trt_map <- data.frame(
Ring = factor(c(1, 2, 3, 4, 5, 6)),
Trt = c("eCO2", "aCO2", "aCO2", "eCO2", "eCO2", "aCO2")
)
# 2. HELPER FUNCTIONS (THE ENGINE) ----------------------------------------
# Function A: Process RATE files (mg/day -> g/year)
# Used for: Roots, Soil Mineralization
process_rate <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) { message(paste("MISSING:", filename)); return(NULL) }
read_csv(f, show_col_types = FALSE) %>%
mutate(Year = year(ymd(Date)), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
mutate(Grams = (get(col) * Days) / 1000) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(Grams, na.rm=TRUE), .groups="drop")
}
# Function B: Process TOTAL files (Summing existing grams)
# Used for: Wood Growth, Litter
process_sum <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) { message(paste("MISSING:", filename)); return(NULL) }
read_csv(f, show_col_types = FALSE) %>%
mutate(Year = year(ymd(Date)), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(get(col), na.rm=TRUE), .groups="drop")
}
# Function C: Process POOL files (Average Standing Stock)
# Used for: Microbial P, Plant Tissue P
process_pool <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) { message(paste("MISSING:", filename)); return(NULL) }
df <- read_csv(f, show_col_types = FALSE)
# Standardize Date
date_col <- names(df)[grep("Date", names(df), ignore.case = TRUE)][1]
df$Date <- ymd(df[[date_col]])
df <- df %>%
mutate(Year = year(Date), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016)
# Handle Depths (Sum depths if they exist, otherwise just average)
if("Depth" %in% names(df)) {
df <- df %>%
filter(Depth %in% c("0_10", "10_30")) %>% # Focus on active root zone
group_by(Date, Year, Ring) %>%
summarise(Step1 = sum(get(col), na.rm=TRUE), .groups="drop") %>%
rename(Target = Step1)
} else {
df <- df %>% mutate(Target = get(col))
}
df %>%
group_by(Year, Ring) %>%
summarise(Value = mean(Target, na.rm=TRUE), .groups="drop")
}
# 3. DATA LOADING (THE INGREDIENTS) ---------------------------------------
print(">>> Loading Carbon Data...")
# Biomass Growth
c_wood <- process_sum("wood_c_production_flux.csv", "wood_production_flux", path_flux)
c_root <- process_rate("fineroot_c_production_flux.csv", "fineroot_production_flux", path_flux)
# GPP (Photosynthesis)
c_gpp  <- read_csv(file.path(path_flux, "overstorey_gpp_flux.csv"), show_col_types=F) %>%
rename(Year=year, Value=GPP) %>%
mutate(Ring=factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
select(Year, Ring, Value)
print(">>> Loading Phosphorus Fluxes...")
# P Demand (Needs)
p_wood_dem <- process_sum("wood_p_flux.csv", "wood_p_flux", path_flux)
p_leaf_dem <- process_sum("canopy_p_flux.csv", "canopy_p_flux", path_flux)
p_root_dem <- process_rate("fineroot_p_production_flux.csv", "fineroot_p_flux_mg_m2_d", path_flux)
# P Recycling (Internal Savings)
p_wood_ret <- process_sum("sapwood_P_retranslocation_flux.csv", "sapwood_p_retrans_flux", path_flux)
p_leaf_ret <- process_sum("canopy_P_retranslocation_flux.csv", "canopy_p_retrans_flux", path_flux)
p_root_ret <- process_rate("fineroot_P_retranslocation_flux.csv", "fineroot_p_retrans_flux", path_flux)
# P Supply (Soil Mineralization) - Needs specific depth summing
raw_soil <- read_csv(file.path(path_flux, "soil_p_mineralization_flux.csv"), show_col_types=F)
p_supply <- raw_soil %>%
mutate(Year=year(ymd(Date)), Ring=factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
group_by(Date, Year, Ring, Days) %>%
summarise(Daily = sum(p_mineralization_mg_m2_d, na.rm=TRUE), .groups="drop") %>%
mutate(Grams = (Daily * Days)/1000) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(Grams, na.rm=TRUE), .groups="drop")
print(">>> Loading Phosphorus Pools...")
pool_mic <- process_pool("microbial_p_pool.csv", "microbial_p_g_m2", path_pool)
# Combine plant pools
pool_wood <- process_pool("wood_p_pool.csv", "wood_p_pool", path_pool)
pool_leaf <- process_pool("canopy_p_pool.csv", "leaf_p_pool", path_pool)
pool_root <- process_pool("fineroot_p_pool.csv", "fineroot_p_pool", path_pool)
pool_plant <- bind_rows(pool_wood, pool_leaf, pool_root) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(Value, na.rm=TRUE), .groups="drop")
# 4. CALCULATIONS & MERGING -----------------------------------------------
# A. CARBON (Stagnation Check)
df_carbon <- bind_rows(
c_wood %>% mutate(Type = "Wood Growth"),
c_root %>% mutate(Type = "Root Growth")
) %>% left_join(trt_map, by="Ring")
# B. P BUDGET (The Heist)
# Uptake = (Demands) - (Recycling)
df_uptake_calc <- p_wood_dem %>% rename(WD=Value) %>%
left_join(p_leaf_dem, by=c("Year","Ring")) %>% rename(LD=Value) %>%
left_join(p_root_dem, by=c("Year","Ring")) %>% rename(RD=Value) %>%
left_join(p_wood_ret, by=c("Year","Ring")) %>% rename(WR=Value) %>%
left_join(p_leaf_ret, by=c("Year","Ring")) %>% rename(LR=Value) %>%
left_join(p_root_ret, by=c("Year","Ring")) %>% rename(RR=Value) %>%
mutate(Uptake = (WD+LD+RD) - (WR+LR+RR)) %>%
select(Year, Ring, Uptake)
df_budget <- bind_rows(
p_supply %>% mutate(Type = "Soil Supply"),
df_uptake_calc %>% rename(Value=Uptake) %>% mutate(Type = "Tree Uptake")
) %>% left_join(trt_map, by="Ring")
# C. POOLS (The Inventory)
df_pools <- bind_rows(
pool_mic %>% mutate(Type = "Microbial P"),
pool_plant %>% mutate(Type = "Total Plant P")
) %>% left_join(trt_map, by="Ring")
# D. EFFICIENCY (Stoichiometry)
df_pue <- c_gpp %>% rename(GPP=Value) %>%
left_join(p_leaf_dem, by=c("Year","Ring")) %>% rename(LeafP=Value) %>%
mutate(PUE = GPP / LeafP) %>%
left_join(trt_map, by="Ring")
# 5. PLOTTING THE STORY ---------------------------------------------------
# 1. Biomass Stagnation
p1 <- ggplot(df_carbon, aes(x=Trt, y=Value, fill=Trt)) +
geom_boxplot(alpha=0.6) + geom_jitter(width=0.1, alpha=0.5) +
facet_wrap(~Type, scales="free") +
labs(title="1. Biomass Stagnation", y="Carbon Flux (g C m-2 yr-1)", x="") +
theme_bw() + theme(legend.position="none") +
scale_fill_manual(values=c("aCO2"="#F8766D", "eCO2"="#00BFC4"))
# 2. The Heist (Supply vs Uptake)
p2 <- ggplot(df_budget, aes(x=Trt, y=Value, fill=Type)) +
geom_boxplot(alpha=0.6) +
labs(title="2. The Phosphorus Gap", y="P Flux (g P m-2 yr-1)", x="") +
theme_bw() + scale_fill_manual(values=c("orange", "forestgreen")) +
theme(legend.position="bottom")
# 3. The Inventory (Pools)
p3 <- ggplot(df_pools, aes(x=Type, y=Value, fill=Trt)) +
geom_boxplot(alpha=0.6) +
labs(title="3. Phosphorus Inventory", y="P Pool (g P m-2)", x="") +
theme_bw() + scale_fill_manual(values=c("aCO2"="#F8766D", "eCO2"="#00BFC4"))
# 4. Efficiency
p4 <- ggplot(df_pue, aes(x=Trt, y=PUE, fill=Trt)) +
geom_boxplot(alpha=0.6) +
labs(title="4. Efficiency (PUE)", y="g C per g P", x="") +
theme_bw() + theme(legend.position="none") +
scale_fill_manual(values=c("aCO2"="#F8766D", "eCO2"="#00BFC4"))
# 6. SAVE OUTPUT ----------------------------------------------------------
final_plot <- (p1 + p2) / (p3 + p4)
ggsave("MASTER_ANALYSIS_OUTPUT.png", final_plot, width=12, height=10)
print(">>> SUCCESS! Open 'MASTER_ANALYSIS_OUTPUT.png' to see the complete story.")
# ==============================================================================
# 00_Config.R - SHARED SETTINGS AND FUNCTIONS
# ==============================================================================
library(tidyverse)
library(lubridate)
library(lme4)
library(lmerTest)
library(patchwork)
library(ggplot2)
# --- 1. DEFINE PATHS (Edit these ONCE here) ---
path_flux <- "C:/Users/augre/Desktop/UPV S1/Data/2025Bgroup-phosphorusCO2/Flux_data"
path_pool <- "C:/Users/augre/Desktop/UPV S1/Data/2025Bgroup-phosphorusCO2/Pool data"
# --- 2. DEFINE TREATMENTS ---
trt_map <- data.frame(
Ring = factor(c(1, 2, 3, 4, 5, 6)),
Trt = c("eCO2", "aCO2", "aCO2", "eCO2", "eCO2", "aCO2")
)
# --- 3. HELPER FUNCTIONS ---
# Function for Rate Files (mg/day -> g/year)
process_rate <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
read_csv(f, show_col_types = FALSE) %>%
mutate(Year = year(ymd(Date)), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
mutate(Grams = (get(col) * Days) / 1000) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(Grams, na.rm=TRUE), .groups="drop")
}
# Function for Total Files (Summing existing grams)
process_sum <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
read_csv(f, show_col_types = FALSE) %>%
mutate(Year = year(ymd(Date)), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(get(col), na.rm=TRUE), .groups="drop")
}
# Function for Pools (Average Standing Stock)
process_pool <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
df <- read_csv(f, show_col_types = FALSE) %>%
mutate(Date = ymd(Date), Year = year(Date), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016)
if("Depth" %in% names(df)) {
df <- df %>% filter(Depth %in% c("0_10", "10_30")) %>%
group_by(Date, Year, Ring) %>%
summarise(Step1 = sum(get(col), na.rm=TRUE), .groups="drop") %>%
rename(Target = Step1)
} else {
df <- df %>% mutate(Target = get(col))
}
df %>% group_by(Year, Ring) %>% summarise(Value = mean(Target, na.rm=TRUE), .groups="drop")
}
print(">>> Config Loaded: Paths and Functions ready.")
# ==============================================================================
# 00_Config.R - SHARED SETTINGS AND FUNCTIONS
# ==============================================================================
library(tidyverse)
library(lubridate)
library(lme4)
library(lmerTest)
library(patchwork)
library(ggplot2)
# --- 1. DEFINE PATHS (Edit these ONCE here) ---
path_flux <- "C:/Users/augre/Desktop/UPV S1/Data/2025Bgroup-phosphorusCO2/Flux_data"
path_pool <- "C:/Users/augre/Desktop/UPV S1/Data/2025Bgroup-phosphorusCO2/Pool data"
# --- 2. DEFINE TREATMENTS ---
trt_map <- data.frame(
Ring = factor(c(1, 2, 3, 4, 5, 6)),
Trt = c("eCO2", "aCO2", "aCO2", "eCO2", "eCO2", "aCO2")
)
# --- 3. HELPER FUNCTIONS ---
# Function for Rate Files (mg/day -> g/year)
process_rate <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
read_csv(f, show_col_types = FALSE) %>%
mutate(Year = year(ymd(Date)), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
mutate(Grams = (get(col) * Days) / 1000) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(Grams, na.rm=TRUE), .groups="drop")
}
# Function for Total Files (Summing existing grams)
process_sum <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
read_csv(f, show_col_types = FALSE) %>%
mutate(Year = year(ymd(Date)), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(get(col), na.rm=TRUE), .groups="drop")
}
# Function for Pools (Average Standing Stock)
process_pool <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
df <- read_csv(f, show_col_types = FALSE) %>%
mutate(Date = ymd(Date), Year = year(Date), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016)
if("Depth" %in% names(df)) {
df <- df %>% filter(Depth %in% c("0_10", "10_30")) %>%
group_by(Date, Year, Ring) %>%
summarise(Step1 = sum(get(col), na.rm=TRUE), .groups="drop") %>%
rename(Target = Step1)
} else {
df <- df %>% mutate(Target = get(col))
}
df %>% group_by(Year, Ring) %>% summarise(Value = mean(Target, na.rm=TRUE), .groups="drop")
}
print(">>> Config Loaded: Paths and Functions ready.")
# ==============================================================================
# 00_Config.R - SHARED SETTINGS AND FUNCTIONS
# ==============================================================================
library(tidyverse)
library(lubridate)
library(lme4)
library(lmerTest)
library(patchwork)
library(ggplot2)
# --- 1. DEFINE PATHS (Edit these ONCE here) ---
path_flux <- "C:/Users/augre/Desktop/UPV S1/Data/2025Bgroup-phosphorusCO2/Flux_data"
path_pool <- "C:/Users/augre/Desktop/UPV S1/Data/2025Bgroup-phosphorusCO2/Pool data"
# --- 2. DEFINE TREATMENTS ---
trt_map <- data.frame(
Ring = factor(c(1, 2, 3, 4, 5, 6)),
Trt = c("eCO2", "aCO2", "aCO2", "eCO2", "eCO2", "aCO2")
)
# --- 3. HELPER FUNCTIONS ---
# Function for Rate Files (mg/day -> g/year)
process_rate <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
read_csv(f, show_col_types = FALSE) %>%
mutate(Year = year(ymd(Date)), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
mutate(Grams = (get(col) * Days) / 1000) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(Grams, na.rm=TRUE), .groups="drop")
}
# Function for Total Files (Summing existing grams)
process_sum <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
read_csv(f, show_col_types = FALSE) %>%
mutate(Year = year(ymd(Date)), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(get(col), na.rm=TRUE), .groups="drop")
}
# Function for Pools (Average Standing Stock)
process_pool <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
df <- read_csv(f, show_col_types = FALSE) %>%
mutate(Date = ymd(Date), Year = year(Date), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016)
if("Depth" %in% names(df)) {
df <- df %>% filter(Depth %in% c("0_10", "10_30")) %>%
group_by(Date, Year, Ring) %>%
summarise(Step1 = sum(get(col), na.rm=TRUE), .groups="drop") %>%
rename(Target = Step1)
} else {
df <- df %>% mutate(Target = get(col))
}
df %>% group_by(Year, Ring) %>% summarise(Value = mean(Target, na.rm=TRUE), .groups="drop")
}
print(">>> Config Loaded: Paths and Functions ready.")
# Load the config file (This loads libraries, paths, and functions)
source("00_Config.R")
print(p2)
print(p3)
ggsave("FINAL_REPORT_ANALYSIS.png", final_plot, width=12, height=10)
#EXPLAINING THE RING EFFECT
# Correlation: Does low Soil P force trees to build more roots?
#EXPLAINING THE RING EFFECT (STANDALONE SCRIPT)
# Correlation: Does low Soil P force trees to build more roots?
#In the previous steps, we found that CO2 did not change tree growth. However, the Rings were very different from each other (The "Ring Effect").
#The Problem: If Ring 5 behaves differently than Ring 1, is it just random noise? Or is the forest acting intelligently?
#The Hypothesis (Optimal Foraging Theory):
#Trees are economic investors. If nutrients are scarce (Low Soil P), the tree should invest more money into Roots to find food.
#If nutrients are abundant (High Soil P), the tree can be lazy with roots and invest more in Wood.
#The Goal: We ran this correlation to prove that the differences between rings are not random errors. They are evidence of Functional Plasticity. The trees are actively responding to the soil chemistry, even if they aren't responding to the CO2.
# 1. SETUP
library(tidyverse)
library(lubridate)
library(ggplot2)
# UPDATE PATHS HERE
path_flux <- "C:/Users/augre/Desktop/UPV S1/Data/2025Bgroup-phosphorusCO2/Flux_data"
path_pool <- "C:/Users/augre/Desktop/UPV S1/Data/2025Bgroup-phosphorusCO2/Pool data"
# Define Treatments
trt_map <- data.frame(
Ring = factor(c(1, 2, 3, 4, 5, 6)),
Trt = c("eCO2", "aCO2", "aCO2", "eCO2", "eCO2", "aCO2")
)
# 2. HELPER FUNCTIONS
# Load Sums (Wood)
process_sum <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
read_csv(f, show_col_types = FALSE) %>%
mutate(Year = year(ymd(Date)), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(get(col), na.rm=TRUE), .groups="drop")
}
# Load Rates (Roots)
process_rate <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
read_csv(f, show_col_types = FALSE) %>%
mutate(Year = year(ymd(Date)), Ring = factor(Ring)) %>%
filter(Year >= 2013 & Year <= 2016) %>%
mutate(Grams = (get(col) * Days) / 1000) %>%
group_by(Year, Ring) %>%
summarise(Value = sum(Grams, na.rm=TRUE), .groups="drop")
}
# Load Pools (Soil P)
process_pool <- function(filename, col, folder) {
f <- file.path(folder, filename)
if(!file.exists(f)) return(NULL)
df <- read_csv(f, show_col_types = FALSE)
date_col <- names(df)[grep("Date", names(df), ignore.case = TRUE)][1]
df$Date <- ymd(df[[date_col]])
df <- df %>% mutate(Year = year(Date), Ring = factor(Ring)) %>% filter(Year >= 2013 & Year <= 2016)
if("Depth" %in% names(df)) {
df <- df %>% filter(Depth %in% c("0_10", "10_30")) %>%
group_by(Date, Year, Ring) %>%
summarise(Step1 = sum(get(col), na.rm=TRUE), .groups="drop") %>%
rename(Target = Step1)
} else {
df <- df %>% mutate(Target = get(col))
}
df %>% group_by(Year, Ring) %>% summarise(Value = mean(Target, na.rm=TRUE), .groups="drop")
}
# 3. CREATE 'df_clean_plot' (Carbon Allocation)
print("Loading Carbon Data...")
c_wood <- process_sum("wood_c_production_flux.csv", "wood_production_flux", path_flux)
c_root <- process_rate("fineroot_c_production_flux.csv", "fineroot_production_flux", path_flux)
df_ratio <- left_join(c_wood, c_root, by = c("Year", "Ring"), suffix = c("_Wood", "_Root")) %>%
left_join(trt_map, by = "Ring") %>%
mutate(Root_Shoot = Value_Root / Value_Wood)
# Clean Data (Remove negative growth/outliers)
df_clean_plot <- df_ratio %>%
filter(Value_Wood > 0) %>%
filter(Root_Shoot > 0) %>%
filter(Root_Shoot < 10.0) # Adjusted filter for your data range
# 4. LOAD SOIL P DATA -----------------------------------------------------
print("Loading Soil P Data...")
df_total_soil <- process_pool("soil_p_pool.csv", "soil_p_g_m2", path_pool)
# 5. MERGE & ANALYZE ------------------------------------------------------
print("Merging and plotting...")
ring_explanation <- df_clean_plot %>%
# Get average Root:Wood ratio per Ring
group_by(Ring) %>%
summarise(Mean_Allocation = mean(Root_Shoot, na.rm = TRUE)) %>%
# Join with the Soil P content for that Ring
left_join(
df_total_soil %>% group_by(Ring) %>% summarise(Mean_Soil_P = mean(Value, na.rm=TRUE)),
by = "Ring"
) %>%
left_join(trt_map, by = "Ring")
# 6. STATISTICS & PLOT ----------------------------------------------------
cor_test <- cor.test(ring_explanation$Mean_Allocation, ring_explanation$Mean_Soil_P)
print("--- CORRELATION RESULT ---")
print(cor_test)
p_correlation <- ggplot(ring_explanation, aes(x = Mean_Soil_P, y = Mean_Allocation, label = Ring)) +
geom_smooth(method = "lm", color = "gray50", se = FALSE, linetype = "dashed") +
geom_point(aes(color = Trt), size = 5) +
geom_text(color = "white", size = 3, fontface = "bold") +
labs(title = "Why do Rings behave differently?",
subtitle = "Correlation: Soil P vs. Root Investment",
x = "Total Soil Phosphorus (g m-2)",
y = "Root : Wood Ratio",
caption = paste("Correlation (r) =", round(cor_test$estimate, 2),
"| P-value =", round(cor_test$p.value, 3))) +
theme_classic() +
scale_color_manual(values = c("aCO2"="#F8766D", "eCO2"="#00BFC4"))
print(p_correlation)
ggsave("Bonus_Ring_Explanation.png", p_correlation, width = 6, height = 5)
print("Analysis Complete.")
#P-value (0.5794): This is much larger than 0.05.
#Meaning: There is no statistically significant relationship between Soil Phosphorus and Root Allocation.
#Correlation (0.28): It is weak and positive (which is actually the opposite of what we expected, but since it's not significant, we treat it as random noise).
#Hypothesis: We thought that rings with Low P would force trees to grow More Roots (Foraging Strategy).Reality: They didn't.
#Why? This strengthens your main argument about "Stagnation" and "Lockout."
#The Phosphorus limitation is so severe and uniform across the entire forest that even the differences between rings (e.g., Ring 1 vs Ring 5) aren't enough to trigger a change in tree behavior. The trees are maxed out everywhere.
