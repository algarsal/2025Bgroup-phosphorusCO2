---

title: "Microbial Competition and Tree Functional Plasticity"
subtitle: "Replicating and Extending Jiang et al. (Nature, 2024)"
author: 
- afiliation: Universitat Politècnica de València.
- name: "Gia Trieu Pham; Ani Ugrelidze; Oishanu Dutta; Muhammad Hasher Naveed"

lang: en-EN
language: 
  title-block-published: "Last changed"
date: last-modified
date-format: iso

format: 
  html:
    theme: cosmo
    toc: true
    number-sections: true
    code-fold: true
    embed-resources: true
    df_print: paged
    output-file: "Preliminary_Results.html"            # Name of the file
    output-dir: "EucFACE_P_Analysis/output"            # Folder to save it in
    
execute:
  warning: false
  message: false
---

```{r setup}
#| include: false

# --- PART 1A: SETUP THE LIBRARY ---
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, lubridate, lme4, lmerTest, knitr, kableExtra, here, broom.mixed, patchwork)

```

```{r}

# --- PART 1B: 
# Visualization Theme
theme_set(theme_classic(base_size = 12))
cols <- c("Ambient" = "#377EB8", "eCO2" = "#E41A1C")

# Helper: Map Rings to Treatments
get_trt <- function(ring) { ifelse(ring %in% c(1,4,5), "eCO2", "Ambient") }

# --- UPDATED & FIXED STATS FUNCTION ---
print_stats <- function(model, caption) {
  # 1. Get ANOVA table safely
  stats_df <- suppressWarnings(anova(model)) %>% as.data.frame()
  
  # 2. Standardize Column Names
  if("F value" %in% names(stats_df)) stats_df <- rename(stats_df, `F-Statistic` = `F value`)
  if("Pr(>F)" %in% names(stats_df))  stats_df <- rename(stats_df, `P-Value` = `Pr(>F)`)
  
  stats_df %>%
    # 3. Round numeric columns
    mutate(across(any_of(c("Sum Sq", "Mean Sq", "F-Statistic")), \(x) round(x, 2)),
           across(any_of(c("NumDF", "Df")), \(x) round(x, 0)),
           across(any_of("DenDF"), \(x) round(x, 1))) %>%
    # 4. robust P-value formatting (Text-based to prevent HTML errors)
    mutate(
      `Sig` = ifelse(!is.na(`P-Value`) & `P-Value` < 0.05, "*", ""), # Add Star for significance
      `P-Value` = ifelse(`P-Value` < 0.001, "< 0.001", sprintf("%.3f", `P-Value`))
    ) %>%
    # 5. Create Table
    kable(caption = caption, align = "r") %>% 
    kable_styling(full_width = F, bootstrap_options = "striped") %>%
    footnote(
      general = "* Indicates statistical significance (P < 0.05).",
      general_title = "Note: "
    )
}

```


# Project Overview
This repository contains the R analysis pipeline used to investigate **Biomass Stagnation** and **Microbial Phosphorus Competition** at the EucFACE (Eucalyptus Free-Air CO$_2$ Enrichment) experiment.

The analysis integrates 6 years of flux and pool data (2013–2018) to test a critical question in climate change ecology: **Can mature forests on low-phosphorus soils sequester additional carbon under elevated CO$_2$?**

# 1. Introduction

### 1.1 The Challenge: Carbon Sequestration in P-Limited Forests
Elevated atmospheric carbon dioxide ($eCO_2$) is widely predicted to act as a "fertilizer" for global forests, stimulating photosynthesis and increasing biomass carbon sequestration. This process is relied upon as a critical buffer against climate change in Earth System Models. However, empirical evidence suggests that in phosphorus-limited landscapes—which cover vast areas of the tropics and subtropics—this fertilization effect often fails to materialize.

This creates a **"Stoichiometric Mismatch"**: while $eCO_2$ increases the supply of Carbon (C), trees require Phosphorus (P) to convert that carbon into biomass (wood and roots). In ancient, weathered soils, P availability is not governed by simple chemical weathering, but by intense biological competition.

### 1.2 The Microbial Pre-emption Hypothesis
Recent work by **Jiang et al. (2024)** posits the **"Microbial Pre-emption Hypothesis"** as the primary driver of this stagnation. The theory suggests that soil microorganisms—which are biologically faster and spatially closer to nutrient sources—outcompete trees for scarce phosphorus. This effectively "locks" the nutrient away from vegetation, creating a bottleneck that prevents the forest from utilizing the extra carbon available in the atmosphere.

### 1.3 Study Site: The EucFACE Experiment
To investigate this phenomenon, we utilize data from the **Eucalyptus Free-Air CO$_2$ Enrichment (EucFACE)** experiment. Located in the Cumberland Plain woodlands of New South Wales, Australia, EucFACE is the only fully operational Free-Air CO$_2$ experiment in a mature, native forest in the Southern Hemisphere.

**Site Characteristics:**
The ecosystem is a mature, evergreen *Eucalyptus tereticornis* woodland situated on ancient alluvial soils. Crucially, the site has a unique disturbance history: it has been unmanaged for over 90 years and has not experienced forest fire for approximately 200 years. This lack of fire-driven nutrient recycling has driven the ecosystem into a state of extreme phosphorus limitation, making it the ideal testbed for nutrient-constraint hypotheses.

**Experimental Design:**
The experiment consists of six open-air arrays (referred to as **"Rings"**), each 25 meters in diameter and rising into the canopy.
*   **Treatment ($eCO_2$):** 3 Rings release $CO_2$ programmed to maintain concentrations 150 ppm above ambient levels.
*   **Control ($aCO_2$):** 3 Rings release ambient air to control for infrastructure effects.


## 2. Data Description & Methodologies

### 2.1 Measurement Methodologies
The data originates from a comprehensive field campaign at EucFACE (2013–2018). The following specific methods were used to quantify Carbon and Phosphorus stocks and fluxes:

*   **Vegetation Sampling:**
    *   **Woody Biomass:** Tree growth was measured using dendrometer bands (metal bands around trunks) to track stem increment. Tissue samples (sapwood/heartwood) were collected via drilling.
    *   **Canopy Turnover:** Leaf litterfall was collected monthly using eight circular fine-mesh traps ($0.2 m^2$) per ring.
    *   **Root Biomass:** Fine roots ($<2mm$) were sampled using soil coring (augers) and in-growth cores (mesh bags buried in soil) to measure production rates over time.

*   **Chemical Analysis (The "Gold Standard"):**
    *   **Leaf Tissue:** Dried and ground samples underwent **Kjeldahl digestion** (sulfuric acid + hydrogen peroxide) followed by **colorimetric analysis** (molybdate reaction) to determine P concentration.
    *   **Woody Tissue:** Samples were analyzed using **Inductively Coupled Plasma Optical Emission Spectroscopy (ICP-OES)**.
    *   **Root Tissue:** Total P concentration in fine roots was assessed using **X-ray Fluorescence Spectrometry**.

*   **Soil & Microbial Analysis:**
    *   **Total Soil P:** Determined via **Aqua Regia digestion** followed by ICP-MS analysis.
    *   **Microbial P:** Measured using **Chloroform Fumigation-Extraction**. Soil samples are fumigated to lyse (burst) microbial cells, releasing their internal P, which is then measured against non-fumigated controls.
    *   **Net Mineralization (Flux):** Measured *in situ* using PVC soil cores incubated in the ground. The change in phosphate concentration over time represents the net supply rate from soil to plants.

### 2.2 Data Structure and Processing
*   **File Organization:** Raw data is stored in `.csv` files.
*   **Spatial Aggregation:** Soil and microbial data, collected at distinct depths (0-10 cm, 10-30 cm), were summed to represent the total active root zone (0-30 cm) for ecosystem-level comparisons.

**Rationale:**
We included **Ring** as a random intercept to account for the split-plot experimental design. Trees within the same ring are not independent; they share the same soil, microclimate, and history. Furthermore, one ring might naturally have better soil quality than another, regardless of CO2 treatment. Using a random intercept controls for this spatial heterogeneity and prevents pseudoreplication, ensuring that we test the *relative* effect of $eCO_2$ within the system.

---

**Statistical Analysis:**\
We performed data cleaning and aggregation in R (v4.3). We used **Linear Mixed-Effects Models (LMM)** via the lme4 package to test for treatment effects, using **Ring** as a random intercept to account for the spatial nesting of the experimental design *(`Variable∼Treatment×Year+(1∣Ring)).`*

## 3. Research Hypotheses

Based on the Microbial Pre-emption theory, we tested four specific predictions:

*   **H1: The Stagnation Hypothesis (Carbon):** Due to nutrient limitation, trees under $eCO_2$ will **not** show a significant increase in woody biomass or root biomass production compared to ambient trees.
*   **H2: The Nutrient Bottleneck Hypothesis (Fluxes):** Plant Phosphorus uptake will be constrained by microbial competition. We predict that uptake will not increase under $eCO_2$, and that total uptake will exceed measurable soil supply, indicating tight recycling and microbial immobilization.
*   **H3: The Hoarding Hypothesis (Pools):** Soil microbes will sequester a substantial portion of the ecosystem's phosphorus. We predict the **Microbial P Pool** will be significantly larger than the available soil P pool and comparable to the total vegetation P pool.
*   **H4: The Functional Plasticity Hypothesis (Efficiency):** Trees will attempt to adapt to the limitation. We predict trees under $eCO_2$ will exhibit higher **Phosphorus Use Efficiency (PUE)**, assimilating more Carbon per unit of Phosphorus used.

## 4. Analytical Framework

This study employs a four-stage mass-balance analysis to trace the fate of Carbon and Phosphorus through the ecosystem:

1.  **Biomass Assessment:** Testing for physical growth responses (Wood/Root growth).
2.  **Flux Budgeting:** Comparing **Soil P Supply** (Net Mineralization) against **Tree P Uptake** to quantify the magnitude of the nutrient deficit.
3.  **Pool Inventory:** Mapping where Phosphorus is stored to test for microbial hoarding.
4.  **Efficiency Analysis:** Evaluating **Phosphorus Use Efficiency (PUE)** to measure physiological adaptation.

```{r}
#| label: data-processing

# --- 1. ROBUST DATA LOADER ---
load_data <- function(filename, val_col_pattern, type = "pool") {
  path <- here("EucFACE_P_Analysis/data", filename)
  if(!file.exists(path)) path <- here("data", filename) 
  if(!file.exists(path)) return(NULL)
  
  df <- read_csv(path, show_col_types = FALSE)
  val_col <- names(df)[grepl(val_col_pattern, names(df), ignore.case = TRUE)][1]
  
  clean_df <- df %>%
    mutate(Date = parse_date_time(Date, orders = c("ymd", "dmy", "mdy")),
           Year = year(Date)) %>%
    filter(!is.na(Date)) %>% 
    rename(Value = all_of(val_col))
    
  if (type == "pool") {
    out <- clean_df %>% group_by(Year, Ring) %>% summarise(Val = mean(Value, na.rm=TRUE), .groups="drop")
  } else if (type == "sum_depth") {
    out <- clean_df %>% 
      filter(Depth %in% c("0_10", "10_30")) %>%
      group_by(Date, Ring) %>% summarise(DailySum = sum(Value), .groups="drop") %>%
      mutate(Year = year(Date)) %>%
      group_by(Year, Ring) %>% summarise(Val = mean(DailySum, na.rm=TRUE), .groups="drop")
  } else if (type == "flux") {
    out <- clean_df %>% group_by(Year, Ring) %>% summarise(Val = mean(Value, na.rm=TRUE)*365/1000, .groups="drop")
  }
  return(out)
}

# --- 2. EXECUTE LOADING ---
soil_p  <- load_data("soil_phosphate_pool.csv", "phosphate", type="sum_depth") %>% rename(Soil_P = Val)
micro_p <- load_data("microbial_p_pool.csv", "microbial", type="sum_depth") %>% rename(Micro_P = Val)
wood_c  <- load_data("wood_c_pool.csv", "wood", type="pool") %>% rename(Wood_C = Val)
root_c  <- load_data("fineroot_c_pool.csv", "fineroot", type="pool") %>% rename(Root_C = Val)
gpp     <- load_data("overstorey_gpp_flux.csv", "GPP", type="pool") %>% rename(GPP = Val)

litter_files <- c("leaflitter_p_flux.csv", "twiglitter_p_flux.csv", "bark_litter_p_flux.csv", "seed_litter_p_flux.csv")
litter_list  <- lapply(litter_files, function(f) load_data(f, "flux|mg", type="flux"))
litter_p <- bind_rows(litter_list) %>% 
  group_by(Year, Ring) %>% 
  summarise(Total_P_Lost = sum(Val, na.rm=TRUE), .groups="drop")

# --- 3. MASTER MERGE ---
df_list <- list(wood_c, root_c, gpp, litter_p, soil_p, micro_p)
df <- df_list %>% 
  reduce(full_join, by = c("Year", "Ring")) %>% 
  mutate(Trt = get_trt(Ring), Ring = factor(Ring)) %>% 
  filter(Year >= 2013 & Year <= 2016) %>% 
  mutate(PUE = GPP / Total_P_Lost, Root_Shoot_Ratio = Root_C / Wood_C)
```

# Results: Replication

## The Phosphorus Inventory

We compared the three main Phosphorus compartments: Available Soil P, Microbial P and Tree P Return (Litter Flux).

```{r}
#| label: fig-pools
#| fig-cap: "The Ecosystem Phosphorus Budget. (A) Time series of P pools. Note that the Microbial pool (Middle) is ~10x larger than the Soil pool (Left) or Tree Return (Right). (B) The negative relationship between Microbes and Soil P suggests active drawdown."

# --- 1. PREPARE DATA ---
# We add "Total_P_Lost" (Litter) as a proxy for Tree P cycling
df_long_p <- df %>% 
  select(Year, Ring, Trt, Soil_P, Micro_P, Total_P_Lost) %>% 
  pivot_longer(cols = c(Soil_P, Micro_P, Total_P_Lost), names_to = "Type", values_to = "Val") %>% 
  mutate(Type = recode(Type, 
                       "Soil_P" = "1. Available Soil P", 
                       "Micro_P" = "2. Microbial P (Lockout)",
                       "Total_P_Lost" = "3. Tree P Return (Litter)")) %>% 
  drop_na(Val)

# --- 2. PLOT A: TIME SERIES ---
plot_a <- ggplot(df_long_p, aes(x = Year, y = Val, color = Trt)) +
  geom_line(aes(group = Ring), alpha = 0.3, linewidth = 0.6) + 
  stat_summary(fun = mean, geom = "line", linewidth = 1.2) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.1) +
  facet_wrap(~Type, scales = "free_y", nrow = 1) + 
  scale_color_manual(name = "Treatment", values = cols) +
  scale_x_continuous(breaks = c(2013, 2014, 2015, 2016)) +
  labs(y = "Phosphorus (g P / m²)", x = NULL, title = "A. Magnitude of P Pools") +
  theme(legend.position = "top",
        strip.background = element_rect(fill = "#f0f0f0", color = NA),
        strip.text = element_text(face = "bold", size = 10))

# --- 3. PLOT B: CORRELATION (RELATION) ---
# Is there a trade-off? As Microbes go UP, does Soil P go DOWN?
plot_b <- ggplot(df, aes(x = Micro_P, y = Soil_P, color = Trt)) +
  geom_point(alpha = 0.6, size = 2) +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.2) +
  scale_color_manual(name = "Treatment", values = cols) +
  labs(y = "Available Soil P", x = "Microbial P", title = "B. Microbial Drawdown") +
  theme(legend.position = "none")

# Combine plots using patchwork
combined_plot <- plot_a / plot_b + plot_layout(heights = c(2, 1))
print(combined_plot)
# Export the graphs for presentation
ggsave(here("EucFACE_P_Analysis/output", "Fig1_Phosphorus_Budget.png"), 
       plot = combined_plot, width = 10, height = 7, dpi = 300)
```

```{r}
#| label: tbl-pools
#| tbl-cap: "ANOVA: Comparison of Ecosystem P Compartments."

m_pool <- lmer(Val ~ Type * Trt + (1|Ring), data = df_long_p)
print_stats(m_pool, "Model: Value ~ Compartment * Treatment")
```

**Observation:** As shown in **\@fig-pools (Panel A)**, the Microbial P pool (\~5.0 g/m²) is approximately one order of magnitude larger than the Available Soil P pool (\~0.5 g/m²) or the Tree P Return. The statistical analysis in **\@tbl-pools** confirms that Type is the dominant factor explaining variance (P\<0.001).

**Analysis:** **\@fig-pools (Panel B)** illustrates the mechanism of this limitation. There is a negative correlation between Microbial biomass and Soil P, suggesting that in patches where microbes are abundant, they actively draw down the soil solution, leaving a significant deficit for tree uptake.

## The Consequence: Biomass Stagnation

```{r}
#| label: fig-wood
#| fig-cap: "Wood Biomass Trajectory. Despite elevated CO2, the red line (eCO2) does not diverge from the blue line (Ambient)."

ggplot(df, aes(x=Year, y=Wood_C, color=Trt)) +
  geom_line(aes(group = Ring), alpha = 0.3, linewidth = 0.6) +
  stat_summary(fun=mean, geom="line", linewidth=1.2) +
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.1) +
  scale_color_manual(name="Treatment", values=cols) +
  scale_x_continuous(breaks=2013:2016) +
  labs(y="Wood Carbon (g C / m²)")

ggsave(here("EucFACE_P_Analysis/output", "Fig2_Biomass_Stagnation.png"), 
       width = 8, height = 5, dpi = 300)
```

```{r}
#| label: tbl-wood
#| tbl-cap: "ANOVA: Treatment Effect on Wood Biomass."
# Export the graph for presentation
m_wood <- lmer(Wood_C ~ Trt * as.factor(Year) + (1|Ring), data=df)
print_stats(m_wood, "ANOVA: Treatment Effect on Wood Biomass")
```

**Observation:** The nutrient lockout effectively prevents a differential growth response. As seen in **\@fig-wood**, the wood biomass trajectories for Ambient and eCO2 treatments overlap completely.

**Analysis:** While the forest exhibits significant temporal variation (Year effect, P\<0.001 in **\@tbl-wood**), the **Treatment effect** remains non-significant (P=0.957). This confirms the **Stagnation Hypothesis**: without access to the sequestered phosphorus, trees cannot convert the elevated atmospheric Carbon into woody biomass.

# Results: Extension Phase (Adaptation)

## Root Investment Strategies

```{r}
#| label: fig-root
#| fig-cap: "Root:Wood Allocation Ratio. The high variability in the faint lines (individual rings) suggests that allocation strategies are driven more by local conditions than by the global CO2 treatment."

ggplot(df %>% filter(!is.na(Root_Shoot_Ratio)), aes(x = Year, y = Root_Shoot_Ratio, color = Trt)) +
  geom_line(aes(group = Ring), alpha = 0.4, linewidth = 0.8) + 
  geom_point(aes(group = Ring), alpha = 0.4) +
  stat_summary(aes(group = Trt), fun = mean, geom = "line", 
               linewidth = 1.5, linetype = "dashed") +
  scale_color_manual(name="Treatment", values = cols) +
  scale_x_continuous(breaks = 2013:2016) +
  labs(y = "Root : Wood Ratio", x = "Year")

# Export the graph for presentation
ggsave(here("EucFACE_P_Analysis/output", "Fig3_Root_Allocation.png"), 
       width = 8, height = 5, dpi = 300)
```

```{r}
#| label: tbl-root
#| tbl-cap: "ANOVA: Effect of Individual Rings on Allocation."

lm_ring <- lm(Root_Shoot_Ratio ~ Ring + as.factor(Year), data = df)
print_stats(lm_ring, "ANOVA: Effect of Individual Rings on Allocation")
```

**Observation:** The "spaghetti plot" in **\@fig-root** reveals high variability between individual rings. While the global eCO2 mean (dashed red line) appears slightly elevated, the error bars overlap.

**Analysis:** **\@tbl-root** reveals that the global Treatment effect is weak, but the **Ring effect** is significant (P=0.043). This indicates **Spatial Contingency**: rather than a uniform response to eCO2​, trees regulate their root foraging based on specific local soil conditions (heterogeneity) within their specific ring.

## Functional Efficiency (PUE)

```{r}
#| label: fig-pue
#| fig-cap: "Functional Plasticity (PUE). eCO2 trees trend towards higher productivity per unit Soil P."

df_flux <- df %>% filter(!is.na(PUE) & !is.na(Soil_P))

ggplot(df_flux, aes(x=Soil_P, y=GPP, color=Trt, fill=Trt)) +
  geom_point(size=3, alpha=0.6, shape=21, color="white") +
  geom_smooth(method="lm", alpha=0.2) +
  scale_color_manual(name="Treatment", values=cols) +
  scale_fill_manual(name="Treatment", values=cols) +
  labs(x="Available Soil Phosphorus (g/m²)", y="Carbon Uptake (GPP)")

# Export the graph for presentation
ggsave(here("EucFACE_P_Analysis/output", "Fig4_Functional_Efficiency.png"), 
       width = 8, height = 5, dpi = 300)
```

```{r}
#| label: tbl-pue
#| tbl-cap: "ANOVA: PUE Interaction (Soil P x Treatment)."

m_pue <- lmer(GPP ~ Soil_P * Trt + (1|Ring), data=df_flux)
print_stats(m_pue, "ANOVA: PUE Interaction")
```

**Observation:** In **\@fig-pue**, the eCO2 regression line (Red) sits visually higher than the Ambient line (Blue), which would imply higher Carbon uptake (GPP) for a given amount of Soil P.

**Analysis:** However, statistical testing in **\@tbl-pue** does not support this visual trend. Both the main Treatment effect (P=0.875) and the Interaction term (P=0.627) are non-significant. We conclude that while there may be a biological tendency toward efficiency, the high variability (noise) in the ecosystem prevents a definitive confirmation of **Functional Plasticity** in this dataset.

# Conclusion

Our results support the "Microbial Pre-emption" hypothesis. We found that microbes sequester the vast majority of ecosystem phosphorus (\@fig-pools), leaving a statistically significant deficit for the trees. This "lockout" explains why the forest remains stagnant in terms of woody biomass (\@fig-wood) despite year-round exposure to elevated CO2.

Interestingly, the forest is not entirely passive. We observed high variability in root allocation strategies (\@fig-root) driven by local conditions (Ring effects), and a visual trend suggesting trees under eCO2 attempt to operate at higher phosphorus use efficiency (\@fig-pue).

# Reference

*Jiang M, Crous KY, Carrillo Y, et al. Microbial competition for phosphorus limits the CO2 response of a mature forest. Nature. 2024;630(8017):660-665. doi:10.1038/s41586-024-07491-0*
